<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>IPL Auction Royale</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Teko:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    /* CORE LAYOUT */
    body { background: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; overflow: hidden; height: 100vh; width: 100vw; display: flex; flex-direction: column; }
    h1, h2, h3, .stat-value { font-family: 'Teko', sans-serif; letter-spacing: 1px; }
    .glass { background: rgba(30, 41, 59, 0.85); border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(12px); }
    
    /* ANIMATIONS */
    .slide-in-left { transform: translateX(0%) !important; }
    .slide-out-left { transform: translateX(-100%); }
    .slide-in-right { transform: translateX(0%) !important; }
    .slide-out-right { transform: translateX(100%); }
    .transition-transform { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    
    .pulse-red { animation: pulse-red 1s infinite; }
    @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } }
    
    .winning-bid { border: 2px solid #22c55e; background: rgba(34, 197, 94, 0.1); }
    .eliminated-team { opacity: 0.5; border: 1px solid #dc2626 !important; }
    .spectator-team { opacity: 0.7; border: 1px solid #eab308 !important; }
    
    input[type=range] { -webkit-appearance: none; background: transparent; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: #eab308; cursor: pointer; margin-top: -10px; box-shadow: 0 0 10px rgba(234, 179, 8, 0.5); }
    input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #475569; border-radius: 2px; }
    
    .stat-bar-bg { width: 100%; height: 6px; background: #334155; border-radius: 3px; overflow: hidden; }
    .stat-bar-fill { height: 100%; background: #fbbf24; }

    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
  </style>
</head>
<body>

  <div id="auth" class="absolute inset-0 z-50 flex flex-col items-center justify-center p-4 bg-slate-900 overflow-y-auto">
    <div class="w-full max-w-md glass p-6 rounded-2xl border border-slate-700 shadow-2xl">
        <div class="text-center mb-6">
            <h1 class="text-6xl font-bold text-yellow-400 mb-1 drop-shadow-lg">IPL AUCTION</h1>
            <p class="text-gray-400 tracking-widest uppercase text-xs">Build Your Legacy</p>
        </div>
        <div class="flex mb-4 bg-slate-800 rounded-lg p-1">
            <button id="tabCreate" class="w-1/2 py-2 rounded-md font-bold transition-all bg-yellow-500 text-black shadow-lg">Create</button>
            <button id="tabJoin" class="w-1/2 py-2 rounded-md font-bold transition-all text-gray-400 hover:text-white">Join</button>
        </div>
        <div id="formCreate" class="space-y-3">
            <input id="createName" class="w-full p-3 rounded-xl bg-slate-800 border border-slate-700 outline-none focus:border-yellow-500 transition text-lg" placeholder="Team Name" maxlength="30" />
            <input id="createPurse" type="number" class="w-full p-3 rounded-xl bg-slate-800 border border-slate-700 outline-none focus:border-yellow-500 transition text-lg font-mono" value="100" min="50" max="500" />
            <button id="btnCreate" class="w-full py-3 bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-400 hover:to-yellow-500 text-black font-bold rounded-xl shadow-lg mt-2 text-lg">HOST GAME</button>
        </div>
        <div id="formJoin" class="space-y-3 hidden">
            <input id="joinName" class="w-full p-3 rounded-xl bg-slate-800 border border-slate-700 outline-none focus:border-blue-500 transition text-lg" placeholder="Team Name" maxlength="30" />
            <input id="joinCode" class="w-full p-3 rounded-xl bg-slate-800 border border-slate-700 outline-none focus:border-blue-500 transition text-lg uppercase font-mono tracking-widest" placeholder="Room Code" maxlength="10" />
            <button id="btnJoin" class="w-full py-3 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 font-bold rounded-xl shadow-lg mt-2 text-lg">JOIN GAME</button>
        </div>
        <div id="rejoinSection" class="hidden mt-4 pt-3 border-t border-gray-700">
            <button id="btnRejoin" class="w-full py-2 bg-slate-700 hover:bg-slate-600 text-gray-300 font-bold rounded-lg text-sm border border-slate-600">REJOIN PREVIOUS GAME</button>
        </div>
    </div>
  </div>

  <div id="room" class="hidden h-full w-full flex-col relative bg-slate-900">
    
    <header class="h-14 bg-slate-900/95 backdrop-blur border-b border-slate-800 flex justify-between items-center px-3 z-40 shrink-0">
        <button id="mobMenuBtn" class="p-2 -ml-2 text-gray-400 hover:text-white lg:hidden"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path></svg></button>
        
        <button id="headerStartBtn" class="hidden bg-green-600 hover:bg-green-500 text-white text-xs font-bold px-3 py-1 rounded shadow animate-pulse">START</button>

        <div class="text-center">
            <div class="text-[8px] text-gray-500 font-bold tracking-widest uppercase">ROOM</div>
            <div class="text-lg font-bold text-white font-mono leading-none" id="displayRoomId">---</div>
        </div>

        <div class="flex items-center gap-3">
            <div class="text-right">
                <div class="text-[8px] text-gray-500 font-bold uppercase">PURSE</div>
                <div id="myPurse" class="text-lg font-bold text-green-400 font-mono leading-none">‚Çπ---</div>
            </div>
            <button id="mobSquadBtn" class="p-2 -mr-2 text-gray-400 hover:text-white relative lg:hidden">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                <span id="squadBadgeCount" class="absolute top-0 right-0 bg-blue-600 text-[9px] text-white px-1.5 rounded-full font-bold border border-slate-900">0</span>
            </button>
        </div>
    </header>

    <main class="flex-1 relative w-full overflow-hidden flex flex-col lg:flex-row">
        
        <div id="leftDrawer" class="fixed inset-y-0 left-0 w-72 bg-slate-900 border-r border-slate-800 z-50 transform -translate-x-full transition-transform duration-300 shadow-2xl flex flex-col lg:relative lg:translate-x-0 lg:w-80 lg:shadow-none lg:z-0">
            <div class="p-3 border-b border-slate-800 flex justify-between items-center bg-slate-950 lg:hidden">
                <span class="font-bold text-yellow-400">GAME MENU</span>
                <button id="closeLeftBtn" class="text-gray-400 hover:text-white text-xl">&times;</button>
            </div>
            <div class="p-4 border-b border-slate-800">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs text-gray-500 font-bold">STATUS</span>
                    <span class="text-xs text-blue-400 font-bold" id="gameStatus">Waiting...</span>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-2 scrollbar-hide">
                <div class="text-[10px] text-gray-500 font-bold px-2 mb-2 uppercase">Competitors</div>
                <div id="teamsList" class="space-y-2"></div>
            </div>
            <div class="p-3 border-t border-slate-800 bg-slate-950 lg:bg-slate-900">
                <button id="leaveBtn" class="w-full py-2 bg-red-900/50 hover:bg-red-800 border border-red-900 text-red-100 font-bold rounded text-sm">Exit Game</button>
            </div>
        </div>

        <div class="flex-1 relative flex flex-col bg-slate-900/50">
            
            <div id="disconnect-alert" class="hidden absolute top-0 left-0 right-0 bg-red-600 text-white text-center py-2 text-sm z-50">
                Connection lost. Reconnecting...
            </div>
            
            <div id="lobbyView" class="absolute inset-0 z-20 flex flex-col items-center justify-center p-6 text-center">
                <p id="waitingMsg" class="text-2xl text-gray-500 font-light animate-pulse mb-6">Waiting for Host...</p>
                <button id="centerStartBtn" class="hidden px-8 py-4 bg-green-600 hover:bg-green-500 text-white font-bold rounded-xl shadow-2xl text-xl animate-bounce transform transition hover:scale-105">
                    START AUCTION
                </button>
                <p id="hostHint" class="hidden text-gray-500 text-sm mt-4">You are the host. Click to begin.</p>
            </div>

            <div id="eliminatedView" class="hidden absolute inset-0 z-30 bg-black/95 flex flex-col items-center justify-center text-center p-6">
                <h2 class="text-5xl font-bold text-red-600 mb-2">DISQUALIFIED</h2>
                <p class="text-lg text-gray-400">Run out of money.</p>
            </div>
            <div id="spectatorView" class="hidden absolute inset-0 z-30 bg-black/90 backdrop-blur-sm flex flex-col items-center justify-center text-center p-6">
                <h2 class="text-4xl font-bold text-yellow-400 mb-2">SPECTATOR MODE</h2>
                <p class="text-gray-300">You have completed your bidding.</p>
            </div>
            <div id="cooldownView" class="hidden absolute inset-0 z-30 bg-slate-900 flex flex-col items-center justify-center text-center p-4">
                <h2 class="text-5xl font-bold mb-2" id="soldStatusTitle">SOLD</h2>
                <p class="text-xl text-gray-300" id="soldStatusText">---</p>
            </div>

            <div id="auctionView" class="hidden flex-col h-full p-2 lg:p-6 overflow-y-auto">
                <div class="w-full max-w-2xl mx-auto glass rounded-xl border border-slate-700 overflow-hidden flex flex-col flex-1 max-h-[600px]">
                    <div class="flex p-4 gap-4 items-center bg-gradient-to-br from-slate-800 to-slate-900 border-b border-slate-700 relative">
                        <div id="timerRing" class="absolute top-2 right-2 w-10 h-10 rounded-full bg-slate-800 border-2 border-slate-600 flex items-center justify-center text-lg font-bold shadow-lg text-white">10</div>
                        <img id="playerImg" src="" class="w-24 h-24 lg:w-32 lg:h-32 object-cover rounded-lg shadow-lg border border-slate-600 bg-slate-800 flex-shrink-0" />
                        <div class="flex-1 min-w-0">
                            <h2 id="playerName" class="text-2xl lg:text-4xl font-bold text-white leading-none truncate">---</h2>
                            <div class="flex flex-wrap gap-1 mt-1 mb-2">
                                <span id="playerRole" class="text-[10px] bg-blue-600 px-1.5 py-0.5 rounded uppercase font-bold text-white">---</span>
                                <span id="countryBadge" class="text-[10px] bg-slate-700 px-1.5 py-0.5 rounded border border-slate-600 text-gray-300">---</span>
                                <span id="statusBadge" class="text-[10px] bg-slate-700 px-1.5 py-0.5 rounded border border-slate-600 text-gray-300">---</span>
                            </div>
                            <div class="grid grid-cols-3 gap-2">
                                <div><div class="flex justify-between text-[8px] text-gray-400">BAT <span id="statBat">0</span></div><div class="stat-bar-bg h-1"><div id="barBat" class="stat-bar-fill"></div></div></div>
                                <div><div class="flex justify-between text-[8px] text-gray-400">BWL <span id="statBowl">0</span></div><div class="stat-bar-bg h-1"><div id="barBowl" class="stat-bar-fill"></div></div></div>
                                <div><div class="flex justify-between text-[8px] text-gray-400">FLD <span id="statField">0</span></div><div class="stat-bar-bg h-1"><div id="barField" class="stat-bar-fill"></div></div></div>
                            </div>
                        </div>
                    </div>
                    <div class="flex-1 flex flex-col justify-center items-center p-4 bg-slate-900/50">
                        <div class="text-[10px] text-gray-500 uppercase tracking-widest mb-1">Current Highest Bid</div>
                        <div id="currentBid" class="text-5xl lg:text-6xl font-bold text-yellow-400 font-mono tracking-tighter">‚Çπ0.00</div>
                        <div id="highestBidderBadge" class="text-xs bg-slate-800 text-gray-400 px-3 py-1 rounded-full mt-2 border border-slate-700">No Bids Yet</div>
                        <div class="text-xs text-gray-500 mt-2">Base: <span id="basePrice" class="text-gray-300">---</span> | Rating: <span id="playerRating" class="text-yellow-500">0</span></div>
                    </div>
                    <div class="p-4 bg-slate-800 border-t border-slate-700">
                        <div class="flex justify-between text-xs text-gray-400 mb-2"><span>Raise Bid</span><span id="sliderValueDisplay" class="text-yellow-400 font-bold text-lg">---</span></div>
                        <input id="bidSlider" type="range" step="0.25" class="w-full mb-4 accent-yellow-500 h-2 bg-slate-600 rounded-lg appearance-none">
                        <div class="flex gap-3 h-12">
                            <button id="skipBtn" class="flex-1 rounded-lg bg-red-900/30 hover:bg-red-900/50 border border-red-900 text-red-400 font-bold transition text-sm">SKIP</button>
                            <button id="bidBtn" class="w-2/3 rounded-lg bg-green-600 hover:bg-green-500 text-white font-bold transition shadow-lg text-lg shadow-green-900/20">BID</button>
                        </div>
                        <button id="finishSquadBtn" class="w-full mt-3 py-2 bg-yellow-600 hover:bg-yellow-500 text-white font-bold rounded text-sm hidden">FINISH & SPECTATE</button>
                        <p id="skipStatus" class="text-[10px] text-gray-500 mt-2 h-3 text-center"></p>
                    </div>
                </div>
            </div>

            <div id="selectionView" class="hidden absolute inset-0 bg-slate-900 z-20 flex flex-col p-4 overflow-y-auto">
                 <h2 class="text-2xl text-yellow-400 font-bold mb-2 text-center">FINAL SQUAD SELECTION</h2>
                 <div class="flex justify-between text-xs text-gray-400 mb-4 px-1 bg-slate-800 p-2 rounded">
                     <span id="selectionCount">0 / 11 Selected</span>
                     <span id="overseasCount" class="text-blue-400">0 / 4 Overseas</span>
                 </div>
                 <div id="selectionList" class="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-4"></div>
                 <div id="leadershipControls" class="bg-slate-800 p-4 rounded-xl border border-slate-700 hidden mb-20">
                     <h3 class="text-yellow-400 font-bold text-sm mb-3 border-b border-gray-600 pb-1">LEADERSHIP</h3>
                     <div class="grid grid-cols-2 gap-4">
                         <div><label class="text-[10px] text-gray-400 block mb-1">CAPTAIN (2x)</label><select id="selectCaptain" class="w-full bg-slate-900 text-white text-sm p-2 rounded border border-slate-600 outline-none"></select></div>
                         <div><label class="text-[10px] text-gray-400 block mb-1">VICE-CAPT (1.5x)</label><select id="selectViceCaptain" class="w-full bg-slate-900 text-white text-sm p-2 rounded border border-slate-600 outline-none"></select></div>
                     </div>
                     <button id="submitTeamBtn" class="w-full mt-4 py-3 bg-green-600 font-bold rounded-lg disabled:opacity-50 text-white">SUBMIT TEAM</button>
                 </div>
            </div>

            <div id="resultView" class="hidden absolute inset-0 bg-slate-900 z-20 flex flex-col items-center justify-center p-6 text-center">
                <h2 class="text-6xl font-bold text-yellow-400 mb-2 drop-shadow-lg">WINNER</h2>
                <div id="winnerName" class="text-4xl font-bold text-white mb-2">---</div>
                <div id="winnerScore" class="text-xl text-green-400 mb-8 font-mono">--- points</div>
                <div class="w-full max-w-md bg-slate-800 p-4 rounded-xl border border-slate-700 h-1/2 overflow-y-auto">
                    <h3 class="text-sm font-bold border-b border-gray-600 pb-2 mb-2 text-left text-gray-400">LEADERBOARD</h3>
                    <div id="rankingList" class="space-y-2 text-left text-sm"></div>
                </div>
            </div>

        </div>

        <div id="rightDrawer" class="fixed inset-y-0 right-0 w-72 bg-slate-900 border-l border-slate-800 z-50 transform translate-x-full transition-transform duration-300 shadow-2xl flex flex-col lg:relative lg:translate-x-0 lg:w-80 lg:shadow-none lg:z-0">
            <div class="p-3 border-b border-slate-800 flex justify-between items-center bg-slate-950 lg:hidden">
                <span class="font-bold text-blue-400">MY SQUAD</span>
                <button id="closeRightBtn" class="text-gray-400 hover:text-white text-xl">&times;</button>
            </div>
            <div class="p-3 bg-slate-800 text-[10px] flex justify-between text-gray-400 uppercase tracking-widest font-bold"><span>Player</span><span>My Team (<span id="squadCount">0/25</span>)</span></div>
            <div id="mySquadList" class="flex-1 overflow-y-auto p-2 space-y-1 scrollbar-hide"><p class="text-gray-600 text-xs text-center mt-10">No players bought yet.</p></div>
        </div>
        <div id="drawerBackdrop" class="fixed inset-0 bg-black/50 z-40 hidden backdrop-blur-sm lg:hidden"></div>
    </main>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <script>
    // --- APP LOGIC (FIXED VERSION) ---
    let myUserId = localStorage.getItem('ipl_user_id');
    if (!myUserId) { 
        myUserId = 'u_' + Date.now().toString(36) + Math.random().toString(36).substr(2); 
        localStorage.setItem('ipl_user_id', myUserId); 
    }
    
    const lastRoom = localStorage.getItem('ipl_last_room');
    if(lastRoom) { 
        document.getElementById('rejoinSection').classList.remove('hidden'); 
        document.getElementById('btnRejoin').onclick = () => { 
            socket.emit('rejoin-game', { userId: myUserId, roomId: lastRoom }); 
        }; 
    }

    const socket = io({ 
        reconnection: true,
        reconnectionDelay: 1000,
        reconnectionAttempts: 10
    });
    
    // Connection status handling
    socket.on('connect', () => {
        document.getElementById('disconnect-alert').classList.add('hidden');
        console.log('Connected to server');
    });
    
    socket.on('disconnect', () => {
        document.getElementById('disconnect-alert').classList.remove('hidden');
        console.log('Disconnected from server');
    });
    
    socket.on('reconnect', (attemptNumber) => {
        console.log('Reconnected after', attemptNumber, 'attempts');
        if (currentRoom) {
            // Clear any stuck UI states
            clearAllViews();
            socket.emit('rejoin-game', { userId: myUserId, roomId: currentRoom });
        }
    });
    
    // New event to clear cooldown on rejoin
    socket.on('clear-cooldown', () => {
        console.log('Clearing cooldown view');
        if (cooldownTimeout) {
            clearTimeout(cooldownTimeout);
            cooldownTimeout = null;
        }
        const cooldownView = document.getElementById('cooldownView');
        cooldownView.classList.add('hidden');
        cooldownView.style.display = 'none';
    });
    
    function clearAllViews() {
        // Clear cooldown
        if (cooldownTimeout) {
            clearTimeout(cooldownTimeout);
            cooldownTimeout = null;
        }
        document.getElementById('cooldownView').classList.add('hidden');
        document.getElementById('cooldownView').style.display = 'none';
        document.getElementById('lobbyView').classList.add('hidden');
        document.getElementById('eliminatedView').classList.add('hidden');
        document.getElementById('spectatorView').classList.add('hidden');
        document.getElementById('selectionView').classList.add('hidden');
        document.getElementById('resultView').classList.add('hidden');
    }
    
    // UI Refs
    const els = { 
        leftDrawer: document.getElementById('leftDrawer'), 
        rightDrawer: document.getElementById('rightDrawer'), 
        backdrop: document.getElementById('drawerBackdrop'), 
        auth: document.getElementById('auth'), 
        room: document.getElementById('room'), 
        teamsList: document.getElementById('teamsList'), 
        squadList: document.getElementById('mySquadList'), 
        slider: document.getElementById('bidSlider') 
    };

    const MAX_SQUAD=25, MIN_PLAY=4, MAX_OS_SQUAD=8, MAX_OS_P11=4, BID_INCREMENT=0.25;
    let myId=myUserId, myData=null, currentRoom=null, selectedBid=0, gCurrentBid=0, gCurrentBidderId=null, gCurrentPlayer=null, mySquadArr=[];
    let cooldownTimeout = null;

    function toggleLeft() { 
        const isOpen = els.leftDrawer.classList.contains('slide-in-left');
        if (isOpen) {
            els.leftDrawer.classList.remove('slide-in-left');
            toggleBackdrop(false);
        } else {
            els.leftDrawer.classList.add('slide-in-left');
            els.rightDrawer.classList.remove('slide-in-right'); // Close right if open
            toggleBackdrop(true);
        }
    }
    
    function toggleRight() { 
        const isOpen = els.rightDrawer.classList.contains('slide-in-right');
        if (isOpen) {
            els.rightDrawer.classList.remove('slide-in-right');
            toggleBackdrop(false);
        } else {
            els.rightDrawer.classList.add('slide-in-right');
            els.leftDrawer.classList.remove('slide-in-left'); // Close left if open
            toggleBackdrop(true);
        }
    }
    
    function toggleBackdrop(show) { 
        els.backdrop.classList.toggle('hidden', !show); 
        if(!show) { 
            els.leftDrawer.classList.remove('slide-in-left'); 
            els.rightDrawer.classList.remove('slide-in-right'); 
        } 
    }
    
    document.getElementById('mobMenuBtn').onclick = toggleLeft; 
    document.getElementById('closeLeftBtn').onclick = toggleLeft;
    document.getElementById('mobSquadBtn').onclick = toggleRight; 
    document.getElementById('closeRightBtn').onclick = toggleRight;
    els.backdrop.onclick = () => toggleBackdrop(false);

    document.getElementById('tabCreate').onclick=()=>{ 
        document.getElementById('formCreate').classList.remove('hidden'); 
        document.getElementById('formJoin').classList.add('hidden');
        document.getElementById('tabCreate').className = 'w-1/2 py-2 rounded-md font-bold transition-all bg-yellow-500 text-black shadow-lg';
        document.getElementById('tabJoin').className = 'w-1/2 py-2 rounded-md font-bold transition-all text-gray-400 hover:text-white';
    };
    
    document.getElementById('tabJoin').onclick=()=>{ 
        document.getElementById('formCreate').classList.add('hidden'); 
        document.getElementById('formJoin').classList.remove('hidden');
        document.getElementById('tabJoin').className = 'w-1/2 py-2 rounded-md font-bold transition-all bg-yellow-500 text-black shadow-lg';
        document.getElementById('tabCreate').className = 'w-1/2 py-2 rounded-md font-bold transition-all text-gray-400 hover:text-white';
    };

    document.getElementById('btnCreate').onclick = () => {
        const teamName = document.getElementById('createName').value.trim();
        const purse = document.getElementById('createPurse').value;
        
        if (!teamName) {
            return Toastify({ text: "Enter team name", style: { background: "#dc2626" } }).showToast();
        }
        
        socket.emit('create-room', { teamName, purse, userId: myUserId });
    };
    
    document.getElementById('btnJoin').onclick = () => {
        const teamName = document.getElementById('joinName').value.trim();
        const roomCode = document.getElementById('joinCode').value.trim().toUpperCase();
        
        if (!teamName || !roomCode) {
            return Toastify({ text: "Enter team name and room code", style: { background: "#dc2626" } }).showToast();
        }
        
        socket.emit('join-room', { roomId: roomCode, teamName, userId: myUserId });
    };
    
    const quitGame = () => { 
        if(confirm("Leave this game? You can rejoin later.")) { 
            socket.emit('leave-room', { roomId: currentRoom, userId: myUserId }); 
            localStorage.removeItem('ipl_last_room'); 
            location.reload(); 
        } 
    };
    
    document.getElementById('leaveBtn').onclick = quitGame;
    
    document.getElementById('finishSquadBtn').onclick = () => { 
        if(confirm("Stop bidding and become spectator?")) {
            socket.emit('finish-bidding-for-me', { roomId: currentRoom, userId: myUserId }); 
        }
    };

    socket.on('error-message', (msg) => {
        Toastify({ text: msg, duration: 3000, style: { background: "#dc2626" } }).showToast();
    });

    socket.on('room-created', initGame); 
    socket.on('joined-room', initGame);
    
    function initGame({ roomId, team, isHost }) {
        // Clear any stuck views first
        clearAllViews();
        
        els.auth.style.display = 'none'; 
        els.room.classList.remove('hidden'); 
        els.room.classList.add('flex');
        
        currentRoom = roomId; 
        localStorage.setItem('ipl_last_room', roomId); 
        myId = team.id; 
        myData = team;
        
        document.getElementById('displayRoomId').textContent = roomId; 
        updatePurse(team.purse);
        
        if(isHost) {
            document.getElementById('centerStartBtn').classList.remove('hidden');
            document.getElementById('headerStartBtn').classList.remove('hidden');
            document.getElementById('hostHint').classList.remove('hidden');
            document.getElementById('waitingMsg').classList.add('hidden');
            
            document.getElementById('centerStartBtn').onclick = () => socket.emit('start-auction', { roomId: currentRoom });
            document.getElementById('headerStartBtn').onclick = () => socket.emit('start-auction', { roomId: currentRoom });
        }
    }

    socket.on('teams-updated', (teams) => {
        els.teamsList.innerHTML = ''; 
        let meExists = false;
        
        teams.forEach(t => {
            if(t.id === myId) {
                meExists = true; 
                myData = t; 
                mySquadArr = t.squad; 
                updatePurse(t.purse); 
                renderMySquad(t.squad);
                
                document.getElementById('eliminatedView').classList.toggle('hidden', !t.isEliminated);
                document.getElementById('spectatorView').classList.toggle('hidden', !t.isFinishedBidding);
            }
            
            const badge = t.isEliminated 
                ? '<span class="text-[9px] bg-red-600 px-1 rounded">OUT</span>' 
                : (t.isFinishedBidding ? '<span class="text-[9px] bg-yellow-600 px-1 rounded">DONE</span>' : '');
            
            const div = document.createElement('div'); 
            div.className = `p-2 rounded flex justify-between items-center bg-slate-800 border border-slate-700`;
            div.innerHTML = `<div><div class="font-bold text-xs text-white">${escapeHtml(t.name)} ${badge}</div><div class="text-[9px] text-gray-400">${t.squad.length}/${MAX_SQUAD}</div></div><div class="text-green-400 font-mono text-xs">‚Çπ${t.purse.toFixed(2)}</div>`;
            els.teamsList.appendChild(div);
        });
        
        if(!meExists && currentRoom) { 
            alert("You have been removed from the game."); 
            localStorage.removeItem('ipl_last_room'); 
            location.reload(); 
        }
        
        const btn = document.getElementById('finishSquadBtn');
        if(myData && myData.squad.length >= MIN_PLAY && !myData.isFinishedBidding && !myData.isEliminated) {
            btn.classList.remove('hidden'); 
        } else {
            btn.classList.add('hidden');
        }
        
        refreshControls();
    });

    socket.on('auction-started-signal', () => { 
        document.getElementById('lobbyView').classList.add('hidden');
        document.getElementById('headerStartBtn').classList.add('hidden');
        document.getElementById('auctionView').classList.remove('hidden'); 
        document.getElementById('auctionView').style.display='flex';
        document.getElementById('gameStatus').textContent = "Live"; 
    });

    socket.on('new-player', ({ player, currentBid }) => {
        console.log('New player received:', player.name);
        
        // Clear any existing cooldown
        if (cooldownTimeout) {
            clearTimeout(cooldownTimeout);
            cooldownTimeout = null;
        }
        
        // Force hide ALL overlays first
        document.getElementById('lobbyView').classList.add('hidden');
        document.getElementById('eliminatedView').classList.add('hidden');
        document.getElementById('selectionView').classList.add('hidden');
        document.getElementById('resultView').classList.add('hidden');
        
        // Hide cooldown view and show auction view
        const cooldownView = document.getElementById('cooldownView');
        const auctionView = document.getElementById('auctionView');
        
        cooldownView.classList.add('hidden');
        cooldownView.style.display = 'none';
        
        auctionView.classList.remove('hidden'); 
        auctionView.style.display = 'flex';
        
        // Check spectator mode AFTER showing auction view
        if(myData && myData.isFinishedBidding) {
            document.getElementById('spectatorView').classList.remove('hidden');
        } else {
            document.getElementById('spectatorView').classList.add('hidden');
        }
        
        // Check eliminated mode
        if(myData && myData.isEliminated) {
            document.getElementById('eliminatedView').classList.remove('hidden');
        }
        
        gCurrentPlayer = player;
        document.getElementById('playerImg').src = player.img; 
        document.getElementById('playerName').textContent = player.name;
        document.getElementById('playerRole').textContent = player.role; 
        document.getElementById('playerRating').textContent = player.rating;
        document.getElementById('basePrice').textContent = player.basePrice + " Cr";
        document.getElementById('countryBadge').textContent = player.country === "India" ? "üáÆüá≥ IND" : "‚úàÔ∏è OS";
        document.getElementById('statusBadge').textContent = player.status === "Capped" ? "üß¢ CAP" : "üî∞ UNCAP";
        document.getElementById('statBat').textContent = player.bat; 
        document.getElementById('barBat').style.width = player.bat + "%";
        document.getElementById('statBowl').textContent = player.bowl; 
        document.getElementById('barBowl').style.width = player.bowl + "%";
        document.getElementById('statField').textContent = player.field; 
        document.getElementById('barField').style.width = player.field + "%";
        
        if(myData && !myData.isFinishedBidding && !myData.isEliminated) {
            const sb = document.getElementById('skipBtn'); 
            sb.disabled=false; 
            sb.classList.remove('opacity-50','cursor-not-allowed'); 
            sb.textContent = "SKIP";
            document.getElementById('skipStatus').textContent = "";
        }
        
        updateBidUI(currentBid, null, null);
    });

    socket.on('timer-update', sec => { 
        const ring = document.getElementById('timerRing'); 
        ring.textContent = sec;
        
        if(sec <= 3) {
            ring.classList.add('pulse-red', 'text-red-500', 'border-red-500'); 
        } else {
            ring.classList.remove('pulse-red', 'text-red-500', 'border-red-500');
        }
    });

    socket.on('bid-updated', ({ currentBid, bidderId, bidderName }) => {
        updateBidUI(currentBid, bidderId, bidderName);
    });

    function updateBidUI(amount, bidderId, bidderName) {
        gCurrentBid = amount; 
        gCurrentBidderId = bidderId;
        
        document.getElementById('currentBid').textContent = "‚Çπ" + amount.toFixed(2);
        
        const badge = document.getElementById('highestBidderBadge');
        if(bidderId) { 
            badge.textContent = bidderId === myId ? "YOU" : escapeHtml(bidderName); 
            badge.className = `text-[10px] px-2 py-1 rounded font-bold ${bidderId === myId ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}`; 
        } else { 
            badge.textContent = "NO BIDS"; 
            badge.className = "text-[10px] bg-slate-700 text-gray-300 px-2 py-1 rounded"; 
        }
        
        refreshControls();
    }

    function refreshControls() {
        const bidBtn = document.getElementById('bidBtn');
        const skipBtn = document.getElementById('skipBtn');
        const slider = document.getElementById('bidSlider');
        
        if(!myData) return;
        
        if(myData.isEliminated || myData.isFinishedBidding) { 
            bidBtn.disabled = true; 
            bidBtn.textContent = myData.isEliminated ? "ELIMINATED" : "SPECTATING"; 
            skipBtn.disabled = true; 
            slider.disabled = true; 
            return; 
        }
        
        if(gCurrentPlayer && gCurrentPlayer.country === "Overseas") {
            const osCount = myData.squad.filter(p => p.country === "Overseas").length;
            if(osCount >= MAX_OS_SQUAD) { 
                bidBtn.disabled = true; 
                bidBtn.textContent = "OS LIMIT (8)"; 
                slider.disabled = true; 
                return; 
            }
        }
        
        const minBid = gCurrentBid + BID_INCREMENT;
        
        if(minBid > myData.purse) { 
            bidBtn.disabled = true; 
            bidBtn.textContent = "NO FUNDS"; 
            slider.disabled = true; 
            return; 
        }
        
        if(myData.squad.length >= MAX_SQUAD) { 
            bidBtn.disabled = true; 
            bidBtn.textContent = "SQUAD FULL"; 
            slider.disabled = true;
            return; 
        }
        
        if (gCurrentBidderId === myId) { 
            bidBtn.disabled = true; 
            bidBtn.textContent = "WINNING"; 
            skipBtn.disabled = true; 
            slider.disabled = true; 
        } else {
            slider.disabled = false; 
            slider.min = minBid; 
            slider.max = myData.purse; 
            slider.value = minBid; 
            selectedBid = minBid;
            
            document.getElementById('sliderValueDisplay').textContent = "‚Çπ" + minBid.toFixed(2);
            bidBtn.disabled = false; 
            bidBtn.textContent = `BID (‚Çπ${selectedBid.toFixed(2)})`;
            
            if(skipBtn.textContent !== "SKIPPED") { 
                skipBtn.disabled = false; 
                skipBtn.classList.remove('opacity-50','cursor-not-allowed'); 
            }
        }
    }

    els.slider.oninput = function() { 
        selectedBid = parseFloat(this.value); 
        document.getElementById('sliderValueDisplay').textContent = "‚Çπ" + selectedBid.toFixed(2); 
        document.getElementById('bidBtn').textContent = `BID (‚Çπ${selectedBid.toFixed(2)})`; 
    };
    
    document.getElementById('bidBtn').onclick = () => {
        if (!myData || myData.isEliminated || myData.isFinishedBidding) return;
        socket.emit('place-bid', { roomId: currentRoom, bidAmount: selectedBid, userId: myUserId });
    };
    
    document.getElementById('skipBtn').onclick = () => { 
        socket.emit('skip-for-me', { roomId: currentRoom, userId: myUserId }); 
        const sb = document.getElementById('skipBtn'); 
        sb.disabled=true; 
        sb.textContent = "SKIPPED"; 
        sb.classList.add('opacity-50','cursor-not-allowed'); 
    };
    
    socket.on('player-sold', ({ player, price, teamName }) => {
        showCooldown("SOLD", `${player.name} sold to ${escapeHtml(teamName)} for ‚Çπ${price}Cr`);
    });
    
    socket.on('player-unsold', ({ player }) => {
        showCooldown("UNSOLD", `${player.name} went unsold`);
    });

    function showCooldown(title, subtext) {
        console.log('Showing cooldown:', title, subtext);
        
        // Hide auction view completely
        const auctionView = document.getElementById('auctionView');
        auctionView.style.display = 'none'; 
        auctionView.classList.add('hidden');
        
        // Show cooldown view
        const cd = document.getElementById('cooldownView'); 
        cd.classList.remove('hidden');
        cd.style.display = 'flex'; 
        
        document.getElementById('soldStatusTitle').textContent = title;
        document.getElementById('soldStatusTitle').className = title === "SOLD" 
            ? "text-5xl font-bold text-green-400 mb-2" 
            : "text-5xl font-bold text-red-400 mb-2";
        document.getElementById('soldStatusText').textContent = subtext;
        
        // Clear any existing timeout
        if (cooldownTimeout) {
            clearTimeout(cooldownTimeout);
        }
        
        // Set failsafe timeout (server should send new-player before this)
        cooldownTimeout = setTimeout(() => {
            console.log('Cooldown timeout reached - failsafe triggered');
            cd.classList.add('hidden');
            cd.style.display = 'none';
            cooldownTimeout = null;
        }, 10000); // 10 second failsafe
    }

    socket.on('start-selection-phase', () => {
        if (cooldownTimeout) {
            clearTimeout(cooldownTimeout);
            cooldownTimeout = null;
        }
        
        document.getElementById('auctionView').style.display = 'none'; 
        document.getElementById('cooldownView').style.display = 'none'; 
        document.getElementById('spectatorView').style.display = 'none';
        document.getElementById('selectionView').classList.remove('hidden'); 
        renderSelectionList();
    });

    function renderSelectionList() {
        const container = document.getElementById('selectionList'); 
        container.innerHTML = '';
        
        if (!mySquadArr || mySquadArr.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center col-span-2">No players in squad</p>';
            return;
        }
        
        mySquadArr.forEach(p => {
            const osBadge = p.country === "Overseas" ? "‚úàÔ∏è" : "";
            const div = document.createElement('div');
            div.className = "bg-slate-800 p-3 rounded-lg flex justify-between items-center border border-slate-700";
            div.innerHTML = `<div><div class="font-bold text-sm text-white">${escapeHtml(p.name)} ${osBadge}</div><div class="text-xs text-yellow-500">R: ${p.rating} | ‚Çπ${p.soldPrice}</div></div><input type="checkbox" class="accent-green-500 w-6 h-6 player-select-cb" value="${p.id}" data-country="${p.country}">`;
            container.appendChild(div);
        });
        
        const cbs = document.querySelectorAll('.player-select-cb');
        cbs.forEach(cb => cb.addEventListener('change', updateSelectionUI));
    }

    function updateSelectionUI() {
        const checked = document.querySelectorAll('.player-select-cb:checked');
        const count = checked.length;
        const osCount = Array.from(checked).filter(cb => cb.dataset.country === "Overseas").length;
        const req = Math.min(11, mySquadArr.length);
        
        document.getElementById('selectionCount').textContent = `${count} / ${req} Selected`;
        
        const osEl = document.getElementById('overseasCount'); 
        osEl.textContent = `${osCount} / 4 Overseas`;
        osEl.className = osCount > 4 ? "text-red-500 font-bold" : "text-blue-400";
        
        if (count === req && osCount <= 4) {
            document.getElementById('leadershipControls').classList.remove('hidden'); 
            populateLeadership(checked); 
            document.getElementById('submitTeamBtn').disabled = false;
        } else {
            document.getElementById('leadershipControls').classList.add('hidden'); 
            document.getElementById('submitTeamBtn').disabled = true;
        }
    }

    function populateLeadership(checkedBoxes) {
        const c = document.getElementById('selectCaptain');
        const vc = document.getElementById('selectViceCaptain'); 
        c.innerHTML = ''; 
        vc.innerHTML = '';
        
        checkedBoxes.forEach(cb => {
            const p = mySquadArr.find(pl => pl.id === cb.value);
            if (p) {
                c.add(new Option(`${p.name} (${p.rating})`, p.id)); 
                vc.add(new Option(`${p.name} (${p.rating})`, p.id));
            }
        });
        
        if(vc.options.length>1) vc.selectedIndex=1;
    }

    document.getElementById('submitTeamBtn').onclick = () => {
        const ids = Array.from(document.querySelectorAll('.player-select-cb:checked')).map(cb => cb.value);
        const cId = document.getElementById('selectCaptain').value;
        const vcId = document.getElementById('selectViceCaptain').value;
        
        if(cId === vcId) {
            return Toastify({ text: "Captain & Vice-Captain must be different", duration: 3000, style: { background: "#dc2626" } }).showToast();
        }
        
        socket.emit('submit-playing-11', { 
            roomId: currentRoom, 
            playerIds: ids, 
            cId, 
            vcId, 
            userId: myUserId 
        });
        
        document.getElementById('selectionView').innerHTML = `<div class="flex flex-col items-center justify-center h-full"><h2 class="text-3xl animate-pulse text-yellow-400 text-center">Team Submitted!<br>Waiting for results...</h2></div>`;
    };

    socket.on('game-over-results', ({ winner, rankings }) => {
        document.getElementById('selectionView').classList.add('hidden'); 
        document.getElementById('resultView').classList.remove('hidden');
        
        document.getElementById('winnerName').textContent = winner.name; 
        document.getElementById('winnerScore').textContent = `${winner.totalScore} Total Rating`;
        
        const list = document.getElementById('rankingList'); 
        list.innerHTML = '';
        
        rankings.forEach((t, i) => {
            list.innerHTML += `<div class="flex justify-between p-3 ${i===0?'bg-green-900/50 border border-green-700':'bg-slate-700/50'} rounded-lg mb-2"><span>#${i+1} ${escapeHtml(t.name)}</span><span class="font-bold">${t.totalScore}</span></div>`;
        });
    });

    function updatePurse(amount) { 
        document.getElementById('myPurse').textContent = "‚Çπ" + (amount||0).toFixed(2); 
    }
    
    function renderMySquad(squad) {
        const c = els.squadList; 
        document.getElementById('squadBadgeCount').textContent = squad.length; 
        document.getElementById('squadCount').textContent = `${squad.length}/${MAX_SQUAD}`;
        
        c.innerHTML = squad.length ? '' : '<p class="text-gray-500 text-sm text-center mt-10">Empty.</p>';
        
        squad.forEach(p => {
            c.innerHTML += `<div class="bg-slate-800 p-2 rounded flex items-center justify-between mb-1 border border-slate-700"><div class="flex items-center gap-2 overflow-hidden"><span class="text-sm font-bold truncate text-white">${escapeHtml(p.name)}</span><span class="text-[10px] text-blue-200 bg-blue-900/50 px-1.5 py-0.5 rounded border border-blue-800 shrink-0 uppercase">${p.role}</span>${p.country==="Overseas"?'<span class="text-[10px] shrink-0">‚úàÔ∏è</span>':''}</div><div class="flex items-center gap-2"><span class="text-xs text-gray-400">‚Çπ${p.soldPrice}</span><span class="text-sm text-yellow-500 font-bold">${p.rating}</span></div></div>`;
        });
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
  </script>
</body>
</html>
